name: CI Build & Test with vVIRTUALtarget

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: self-hosted

    steps:
      - name: ğŸ“¥ ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v3

      - name: âš™ï¸ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "VTT_DIR=C:\\Program Files\\Vector\\Vector vVIRTUALtarget 8\\Exec64" >> $env:GITHUB_ENV
          echo "CANOE4SW_SE=C:\\Program Files\\Vector\\Vector CANoe4SW 16" >> $env:GITHUB_ENV
          echo "REPORT_TOOL=C:\\Program Files\\Vector CANoe Test Report Viewer 18" >> $env:GITHUB_ENV

      - name: ğŸ› ï¸ vVIRTUALtargetë¡œ SUT ë¹Œë“œ
        run: |
          "$env:VTT_DIR\\VTT.exe" -build "Projects\\LightControl.vtproj"

      - name: ğŸ§ª Test Unit ì»´íŒŒì¼
        run: |
          "C:\\Tools\\TestUnitBuildCLI.exe" -s Tests\\TestSuite.vttest -o Output\\Tests

      - name: ğŸ—ï¸ í™˜ê²½ ë° í…ŒìŠ¤íŠ¸ ìœ ë‹› ë¹Œë“œ
        run: |
          "C:\\Tools\\environment-make.exe" Config\\LightControl.venvironment.yaml
          "C:\\Tools\\test-unit-make.exe" Output\\Tests

      - name: â–¶ï¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (CANoe4SW-SE)
        run: |
          "$env:CANOE4SW_SE\\canoe4sw-se.exe" -e Output\\SimEnv -r

      - name: ğŸ§¾ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ë³€í™˜
        run: |
          "$env:REPORT_TOOL\\ReportViewerCLI.exe" -i Output\\Results.xml -o report.xml
          cscript.exe Tools\\convert-to-junit.vbs report.xml

      - name: ğŸ“¦ ê²°ê³¼ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: junit-report
          path: report.xml
